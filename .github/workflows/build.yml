name: Build Runit Selftest

on: [pull_request]

jobs:
  linux_build:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Configure and Build project
        run: |
          cmake -S . -B build
          cmake --build build

      - name: Run selftest
        run: ./build/runit-selftest

  stm32f103re_build:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Configure and Build project
        run: |
          cmake -S examples/f103re-cmake-baremetal-builtin -B examples/f103re-cmake-baremetal-builtin/build
          cmake --build examples/f103re-cmake-baremetal-builtin/build

      - name: Flash firmware
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install rhs-flashkit
          rhs-flash examples/f103re-cmake-baremetal-builtin/build/example_f103re.bin --serial ${{ secrets.JLINK_SERIAL_CI_STM32F103RE }}

      - name: Unit tests
        run: |
          source .venv/bin/activate
          pip install rhs-flashkit
          
          HAS_FAILURES=0
          
          TEST_OUTPUT=$(rhs-jlink-rtt --serial ${{ secrets.JLINK_SERIAL_CI_STM32F103RE }} 2>&1)
          
          REPORT_LINES=$(echo "$TEST_OUTPUT" | grep "REPORT")
          if [ -n "$REPORT_LINES" ]; then
          HAS_REPORT_FAILURES=0
          while IFS= read -r line; do
            FAILURES=$(echo "$line" | grep -oP "Failures:\s*\K\d+" || echo "0")
            if [ "$FAILURES" -ne 0 ]; then
            echo "❌ Test FAILED: $line"
            HAS_REPORT_FAILURES=1
            else
            echo "✅ Test PASSED: $line"
            fi
          done <<< "$REPORT_LINES"
          if [ "$HAS_REPORT_FAILURES" -ne 0 ]; then
            HAS_FAILURES=1
          fi
          else
          echo "❌ Test FAILED: No REPORT found"
          HAS_FAILURES=1
          fi
          echo "---"
          
          exit $HAS_FAILURES